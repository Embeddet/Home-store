<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Paystack Integration</title>
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-button {
            background: #00d4aa;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        .test-button:hover {
            background: #00b894;
        }
        .result {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <h1>Paystack Integration Test</h1>
    <p>This page tests the Paystack payment integration before implementing it in the main payment page.</p>
    
    <div id="debug-info" class="result">
        <h3>Debug Information:</h3>
        <div id="debug-content">
            <p>Loading...</p>
        </div>
    </div>
    
    <button class="test-button" onclick="testPaystackPayment()">Test Paystack Payment</button>
    
    <div id="result" class="result" style="display: none;">
        <h3>Result:</h3>
        <pre id="result-content"></pre>
    </div>

    <script>
        // Test Paystack public key (replace with your actual test key)
        const PAYSTACK_PUBLIC_KEY = 'pk_test_99d801b477ef04a8c3b650911a733252e86f2606';
        
        function testPaystackPayment() {
            console.log('Test button clicked');
            
            // Check if PaystackPop is available
            if (typeof PaystackPop === 'undefined') {
                console.error('PaystackPop is undefined');
                showResult('ERROR', { message: 'Paystack library not loaded. Check your internet connection.' });
                return;
            }
            
            console.log('PaystackPop is available:', PaystackPop);
            
            // Workaround for language detection issue
            if (!navigator.language || navigator.language === null) {
                Object.defineProperty(navigator, 'language', {
                    value: 'en-US',
                    writable: false
                });
            }
            
            // Test payment data
            const paymentData = {
                key: PAYSTACK_PUBLIC_KEY,
                email: 'test@example.com',
                amount: 5000, // Amount in kobo (50.00 NGN)
                currency: 'NGN',
                firstname: 'Test',
                lastname: 'User',
                ref: 'test_' + Math.floor((Math.random() * 1000000000) + 1),
                channels: ['card'], // Specify payment channels
                label: 'Test Payment',
                metadata: {
                    custom_fields: [
                        {
                            display_name: "Test Payment",
                            variable_name: "test_payment",
                            value: "true"
                        }
                    ]
                },
                callback: function(response) {
                    console.log('Payment callback triggered:', response);
                    showResult('SUCCESS', response);
                },
                onClose: function() {
                    console.log('Payment modal closed');
                    showResult('CANCELLED', { message: 'Payment was cancelled by user' });
                }
            };
            
            console.log('Payment data prepared:', paymentData);
            
            try {
                console.log('Attempting to call PaystackPop.setup...');
                
                // Add a small delay to ensure DOM is ready
                setTimeout(() => {
                    try {
                        // Try alternative method - direct popup creation
                        const handler = PaystackPop.setup({
                            key: PAYSTACK_PUBLIC_KEY,
                            email: paymentData.email,
                            amount: paymentData.amount,
                            currency: paymentData.currency,
                            ref: paymentData.ref,
                            firstname: paymentData.firstname,
                            lastname: paymentData.lastname,
                            channels: paymentData.channels,
                            label: paymentData.label,
                            metadata: paymentData.metadata,
                            callback: paymentData.callback,
                            onClose: paymentData.onClose
                        });
                        
                        console.log('PaystackPop.setup called successfully, handler:', handler);
                        
                        // Try to manually open the iframe
                        if (handler) {
                            // Check if modal is visible
                            setTimeout(() => {
                                const paystackIframe = document.querySelector('iframe[src*="checkout.paystack.com"]');
                                if (!paystackIframe) {
                                    console.log('Modal not visible, trying to force open...');
                                    showResult('INFO', { 
                                        message: 'Payment handler created but modal not visible. This might be due to popup blockers.',
                                        handler: 'Created successfully'
                                    });
                                } else {
                                    console.log('Payment modal is now visible!');
                                }
                            }, 500);
                        }
                        
                    } catch (setupError) {
                        console.error('Error in PaystackPop.setup:', setupError);
                        showResult('ERROR', { 
                            message: 'Failed to open payment modal: ' + setupError.message,
                            error: setupError.toString()
                        });
                    }
                }, 100);
                
            } catch (error) {
                console.error('Error calling PaystackPop.setup:', error);
                showResult('ERROR', { message: error.message, error: error });
            }
        }
        
        function showResult(status, data) {
            const resultDiv = document.getElementById('result');
            const resultContent = document.getElementById('result-content');
            
            resultContent.textContent = JSON.stringify({
                status: status,
                timestamp: new Date().toISOString(),
                data: data
            }, null, 2);
            
            resultDiv.style.display = 'block';
            
            // Set background color based on status
            switch(status) {
                case 'SUCCESS':
                    resultDiv.style.backgroundColor = '#d4edda';
                    resultDiv.style.borderColor = '#c3e6cb';
                    break;
                case 'ERROR':
                    resultDiv.style.backgroundColor = '#f8d7da';
                    resultDiv.style.borderColor = '#f5c6cb';
                    break;
                case 'CANCELLED':
                    resultDiv.style.backgroundColor = '#fff3cd';
                    resultDiv.style.borderColor = '#ffeaa7';
                    break;
                case 'INFO':
                    resultDiv.style.backgroundColor = '#d1ecf1';
                    resultDiv.style.borderColor = '#bee5eb';
                    break;
            }
        }
        
        // Test if Paystack is loaded
        document.addEventListener('DOMContentLoaded', function() {
            const debugContent = document.getElementById('debug-content');
            
            debugContent.innerHTML = `
                <p><strong>Paystack Public Key:</strong> ${PAYSTACK_PUBLIC_KEY.substring(0, 20)}...</p>
                <p><strong>PaystackPop Available:</strong> ${typeof PaystackPop !== 'undefined' ? 'Yes' : 'No'}</p>
                <p><strong>PaystackPop Object:</strong> ${typeof PaystackPop}</p>
                <p><strong>Current URL:</strong> ${window.location.href}</p>
                <p><strong>Script Source:</strong> https://js.paystack.co/v1/inline.js</p>
                <p><strong>Browser Language:</strong> ${navigator.language}</p>
                <p><strong>User Agent:</strong> ${navigator.userAgent.substring(0, 50)}...</p>
            `;
            
            if (typeof PaystackPop !== 'undefined') {
                console.log('Paystack loaded successfully');
                
                // Try to initialize PaystackPop
                try {
                    if (PaystackPop.initialize && typeof PaystackPop.initialize === 'function') {
                        PaystackPop.initialize();
                        debugContent.innerHTML += '<p style="color: green;"><strong>Status:</strong> Paystack initialized and ready!</p>';
                    } else {
                        debugContent.innerHTML += '<p style="color: green;"><strong>Status:</strong> Ready to test payments!</p>';
                    }
                } catch (initError) {
                    console.error('Error initializing Paystack:', initError);
                    debugContent.innerHTML += '<p style="color: orange;"><strong>Status:</strong> Paystack loaded but initialization failed. Will try without init.</p>';
                }
            } else {
                console.error('Paystack not loaded');
                debugContent.innerHTML += '<p style="color: red;"><strong>Status:</strong> Paystack library failed to load!</p>';
                showResult('ERROR', { message: 'Paystack library failed to load. Check internet connection.' });
            }
        });
    </script>
</body>
</html>
